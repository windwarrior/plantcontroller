{% extends "base_plantcontrol.html" %}

{% block head %}
<script>
    var graphs = 0;
    var delay = 0;
    var threshold = 0;

    $(window).load(function() { 
        $.jsonRPC.setup({
            endPoint: '/plantcontroller/jsonapi/',
            namespace: ''
        });

         $("#status-alert").hide();
    


        graphs = [
            new Graph("#hourlyhumidity", "humidity", 12, 8, 5, 0, 0.5),
            new Graph("#dailyhumidity", "humidity", 48, 7, 30, 0, 0.2),
        ]

        $("#slider-threshold").slider({
            orientation: "horizontal",
            range: "min",
            step: 1,
            max: 1023,
            value: 512,
            slide: function(event, ui){
                threshold = ui.value;
                $("#slider-threshold-value").html((ui.value / 1023).toFixed(2));

            }
        });

        $("#slider-time").slider({
            orientation: "horizontal",
            range: "min",
            step: 1,
            max: 60,
            value: 10,
            slide: function(event, ui){
                delay = ui.value;
                $("#slider-time-value").html(ui.value + " Minutes");
            }
        });

        $.jsonRPC.request('getCurrentActuatorTrigger', {
            params: ["humidity"],
            success: function(result) {
                console.log(result.result);
                if(result.result["error"]){
                    $("#status-alert").addClass("alert-error");                   
                    $("#status-alert").html(result.result["error"]);
                    $("#status-alert").fadeIn();

                    var errortimer = $.timer(function(){
                        $("#status-alert").fadeOut('slow', function(){
                            $("#status-alert").removeClass("alert-error");   
                        });
                        
                    });

                    errortimer.once(5000);
                }

                delay = result.result["delay"];
                threshold = result.result["threshold"];

                setSlider(result.result["delay"], result.result["threshold"]);
                
            },
            error: function(result) {
                console.log(result.result);
            }
        });

        $(function(delay, threshold) {
            setSlider = function(delay, threshold){
                $("#slider-time").slider("value", delay);
                $("#slider-threshold").slider("value", threshold);
                $("#slider-time-value").html(delay + " Minutes");
                $("#slider-time-value-current").html(delay + " Minutes");
                $("#slider-threshold-value").html(threshold.toFixed(2));
                $("#slider-threshold-value-current").html(threshold.toFixed(2));
            }
        });

        $("#save-button").click(function(event){
            console.log(threshold + " " + delay)
            $.jsonRPC.request('storeActuatorTrigger', {
                params: ["humidity", delay, threshold],
                success: function(result) {
                    console.log(result.result);
                
                },
                error: function(result) {
                    console.log(result.result);
                }
            });
        });

    });

    $(window).resize(function(){
        for (var i=0; i<graphs.length; i++){
            graphs[i].onResize();
        }
    });

    var updateFunction = function() {
        for (var i=0; i<graphs.length; i++){
            graphs[i].updateData();
        }
    } 

    var timer = $.timer(updateFunction);

    timer.set({ time : 5000, autostart : true });

</script>

<style>
#slider-time, #slider-threshold{
    margin-top: 20px;
    margin-bottom: 20px;
}

.block{
    display: inline-block;
    width: auto !important;
    min-width: 200px;
}


</style>
{% endblock %}

{% block content %}
    <div class="container-fluid">
    <div class="alert" id="status-alert">Succes!</div>
        <div class="row-fluid">
            <div class="span12">
                <div class="row-fluid">
                    <div class="span5">
                        <div class="page-header">
                            <h4> Hourly </h4>
                        </div>
                        <canvas id="hourlyhumidity"> </canvas>
                    </div>
                    <div class="span7">
                        <div class="page-header">
                             <h4> Control </h4>
                        </div>                        
                        <h5> Threshold value </h5>
                        <small><em> The threshold for below which value the system should give the plant water </em></small><br>
                        <span class="block">Current delaytime</span><span id="slider-threshold-value-current" class="label"></span><br>
                        <span class="block">New threshold</span><span id="slider-threshold-value" class="label label-success"></span>
                        <div id="slider-threshold"></div>
                        <h5>Delay value</h5> 
                        <small><em> The delay for how long the reading should be below the given treshold before watering </em></small><br>
                        <span class="block">Current delaytime</span><span id="slider-time-value-current" class="label"></span><br>
                        <span class="block">New delaytime</span><span id="slider-time-value" class="label label-success"></span>
                        <div id="slider-time"></div> 
                        <button class="btn" id="save-button">Save</button>
                     </div>
                 </div>
                 <div class="row-fluid">
                     <div class="span12">
                         <div class="page-header">
                             <h4> Daily </h4>
                         </div> 
                         <canvas id="dailyhumidity"> </canvas>
                     </div>
                 </div>
            </div>
        </div>
    </div>

{% endblock %}
